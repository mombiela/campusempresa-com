<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link href="/css/site.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  	<script type="text/javascript" src="js/math_init.js"></script>
  	<script type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"></script>
  	<script type="text/javascript" src="/js/cookie.js"></script>
  	<script type="text/javascript" src="/js/main.js"></script>
</head>

<body>
    <div id="content">
		<div id="header" class="container-xxl">
	<div class="row">
		<div class="col-8 p-0">
			<h1 class="m-0 p-0">
				<a href="/"><img src="/img/logo_header.png" style="visibility:hiddenxx;"></a>
			</h1>
		</div>
		<div class="col-4 p-0 text-end">
			<h2 id="main_title"><cite>Construint la societat d'avui<br> i del demà</cite></h2>
			<h3 id="main_subtitle"></h3>
		</div>
	</div>
</div>
<div class="container-xxl" style="margin-top: -1em;">
	<div class="row">
		<div class="col-12 p-0 m-0 text-end">
							<a href="https://campusempresa.com/kubernetes/monitoring-with-prometheus" id="lnk_lang_es" data-lang="es">Castellano</a></b>
				|
				<b id="lit_lang_ca">Catala</b>
								</div>
	</div>
</div>
   <div class="top-bar container-fluid">
	<div class="container-xxl">
		<div class="row">
			<div class="col" id="left_menu">
				<a href="objective">El Projecte</a>
				<a href="about">Sobre nosaltres</a>
				<a href="contribute">Contribuir</a>
				<a href="donate">Donacions</a>
				<a href="licence">Llicència</a>
			</div>
		</div>
	</div>
   </div>

<div class="container-xxl" id="main_content">
	<div class="row">
		<div class="col-12 col-lg-8">
			<div id="nav1" class="navigation"></div>
			<div id="inner_content"><div class='content'></div><h1>Introducció a Prometheus</h1>
<div class='content'><p>Prometheus és un conjunt d'eines de monitoratge i alertes de sistemes de codi obert originalment construït a SoundCloud. Des de la seva creació, s'ha convertit en una opció popular per monitorar clústers de Kubernetes gràcies al seu potent llenguatge de consultes, model de dades flexible i integració perfecta amb Kubernetes.</p>
</div><h2>Conceptes Clau</h2>
<div class='content'><ul>
<li><strong>Base de Dades de Sèries Temporals</strong>: Prometheus emmagatzema totes les dades com a sèries temporals, que són fluxos de valors amb marca de temps que pertanyen al mateix mètric i conjunt de dimensions etiquetades.</li>
<li><strong>Mètriques</strong>: Aquests són els punts de dades fonamentals recollits per Prometheus. Les mètriques poden ser comptadors, indicadors, histogrames o resums.</li>
<li><strong>Etiquetes</strong>: Les etiquetes són parelles clau-valor que s'adhereixen a les mètriques per afegir dimensions a elles.</li>
<li><strong>PromQL</strong>: Llenguatge de Consultes de Prometheus utilitzat per consultar les dades de sèries temporals.</li>
<li><strong>Alertmanager</strong>: Un component que gestiona les alertes enviades per Prometheus.</li>
</ul>
</div><h1>Configuració de Prometheus a Kubernetes</h1>
<div class='content'><p>Per monitorar un clúster de Kubernetes amb Prometheus, cal desplegar Prometheus, configurar-lo per recollir mètriques dels components de Kubernetes i configurar panells de control i alertes.</p>
</div><h2>Desplegament de Prometheus</h2>
<div class='content'><p>Pots desplegar Prometheus utilitzant Helm, un gestor de paquets per a Kubernetes.</p>
<ol>
<li>
<p><strong>Instal·lar Helm</strong>:</p>
<pre><code class="language-bash">curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
</code></pre>
</li>
<li>
<p><strong>Afegir el Repositori Helm de Prometheus</strong>:</p>
<pre><code class="language-bash">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
</code></pre>
</li>
<li>
<p><strong>Instal·lar Prometheus</strong>:</p>
<pre><code class="language-bash">helm install prometheus prometheus-community/prometheus
</code></pre>
</li>
</ol>
</div><h2>Configuració de Prometheus</h2>
<div class='content'><p>La configuració de Prometheus es fa utilitzant un fitxer YAML. A continuació es mostra un exemple bàsic d'un fitxer de configuració de Prometheus (<code>prometheus.yml</code>):</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Z2xvYmFsOgogIHNjcmFwZV9pbnRlcnZhbDogMTVzCgpzY3JhcGVfY29uZmlnczoKICAtIGpvYl9uYW1lOiAna3ViZXJuZXRlcy1hcGlzZXJ2ZXJzJwogICAga3ViZXJuZXRlc19zZF9jb25maWdzOgogICAgICAtIHJvbGU6IGVuZHBvaW50cwogICAgcmVsYWJlbF9jb25maWdzOgogICAgICAtIHNvdXJjZV9sYWJlbHM6IFtfX21ldGFfa3ViZXJuZXRlc19uYW1lc3BhY2UsIF9fbWV0YV9rdWJlcm5ldGVzX3NlcnZpY2VfbmFtZSwgX19tZXRhX2t1YmVybmV0ZXNfZW5kcG9pbnRfcG9ydF9uYW1lXQogICAgICAgIGFjdGlvbjoga2VlcAogICAgICAgIHJlZ2V4OiBkZWZhdWx0O2t1YmVybmV0ZXM7aHR0cHM="))));alert("Copiat!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'kubernetes-apiservers'
    kubernetes_sd_configs:
      - role: endpoints
    relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https</pre></div><div class='content'></div><h2>Recollida de Mètriques</h2>
<div class='content'><p>Prometheus recull mètriques de diversos punts finals. En un entorn Kubernetes, aquests punts finals sovint són exposats per serveis.</p>
<ul>
<li><strong>Node Exporter</strong>: Recull mètriques de maquinari i sistema operatiu.</li>
<li><strong>Kube-State-Metrics</strong>: Exposa mètriques de l'estat del clúster de Kubernetes.</li>
<li><strong>cAdvisor</strong>: Proporciona mètriques d'ús de recursos i rendiment dels contenidors.</li>
</ul>
</div><h2>Exemple: Recollida de Mètriques de Nodes</h2>
<div class='content'><p>Per recollir mètriques de nodes, cal desplegar el Node Exporter i configurar Prometheus per recollir les seves mètriques.</p>
<ol>
<li>
<p><strong>Desplegar Node Exporter</strong>:</p>
<pre><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/prometheus/node_exporter/main/examples/node-exporter-daemonset.yaml
</code></pre>
</li>
<li>
<p><strong>Configurar Prometheus per Recollir Mètriques de Node Exporter</strong>:</p>
<pre><code class="language-yaml">scrape_configs:
  - job_name: 'node-exporter'
    kubernetes_sd_configs:
      - role: node
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:9100
      - source_labels: [__address__]
        target_label: instance
</code></pre>
</li>
</ol>
</div><h1>Visualització de Mètriques amb Grafana</h1>
<div class='content'><p>Grafana és una plataforma de codi obert popular per al monitoratge i l'observabilitat. S'integra perfectament amb Prometheus per visualitzar mètriques.</p>
</div><h2>Desplegament de Grafana</h2>
<div class='content'><ol>
<li>
<p><strong>Instal·lar Grafana utilitzant Helm</strong>:</p>
<pre><code class="language-bash">helm install grafana grafana/grafana
</code></pre>
</li>
<li>
<p><strong>Accedir a Grafana</strong>:</p>
<pre><code class="language-bash">kubectl port-forward service/grafana 3000:80
</code></pre>
</li>
<li>
<p><strong>Afegir Prometheus com a Font de Dades</strong>:</p>
<ul>
<li>Obre Grafana al teu navegador a <code>http://localhost:3000</code>.</li>
<li>Ves a Configuració &gt; Fonts de Dades &gt; Afegir font de dades.</li>
<li>Selecciona Prometheus i introdueix la URL del teu servidor Prometheus (per exemple, <code>http://prometheus-server</code>).</li>
</ul>
</li>
</ol>
</div><h2>Creació de Panells de Control</h2>
<div class='content'><p>Grafana et permet crear panells de control personalitzats per visualitzar les teves mètriques.</p>
<ol>
<li>
<p><strong>Crear un Nou Panell de Control</strong>:</p>
<ul>
<li>Fes clic a la icona &quot;+&quot; a la barra lateral esquerra i selecciona &quot;Dashboard&quot;.</li>
<li>Fes clic a &quot;Add new panel&quot;.</li>
<li>Utilitza PromQL per consultar les teves mètriques i visualitzar-les.</li>
</ul>
<p>Exemple de consulta PromQL per monitorar l'ús de la CPU:</p>
<pre><code class="language-promql">sum(rate(container_cpu_usage_seconds_total[5m])) by (instance)
</code></pre>
</li>
</ol>
</div><h1>Configuració d'Alertes</h1>
<div class='content'><p>Prometheus pot enviar alertes basades en les mètriques que recull. Les alertes es defineixen al fitxer de configuració de Prometheus.</p>
</div><h2>Exemple de Regla d'Alerta</h2>
<div class='content'><p>A continuació es mostra un exemple d'una regla d'alerta que es desencadena si l'ús de la CPU és superior al 80% durant més de 5 minuts:</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Z3JvdXBzOgogIC0gbmFtZTogZXhhbXBsZQogICAgcnVsZXM6CiAgICAgIC0gYWxlcnQ6IEhpZ2hDUFVVc2FnZQogICAgICAgIGV4cHI6IHN1bShyYXRlKGNvbnRhaW5lcl9jcHVfdXNhZ2Vfc2Vjb25kc190b3RhbFs1bV0pKSBieSAoaW5zdGFuY2UpID4gMC44CiAgICAgICAgZm9yOiA1bQogICAgICAgIGxhYmVsczoKICAgICAgICAgIHNldmVyaXR5OiB3YXJuaW5nCiAgICAgICAgYW5ub3RhdGlvbnM6CiAgICAgICAgICBzdW1tYXJ5OiAiSGlnaCBDUFUgdXNhZ2UgZGV0ZWN0ZWQiCiAgICAgICAgICBkZXNjcmlwdGlvbjogIkNQVSB1c2FnZSBpcyBhYm92ZSA4MCUgZm9yIG1vcmUgdGhhbiA1IG1pbnV0ZXMuIg=="))));alert("Copiat!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>groups:
  - name: example
    rules:
      - alert: HighCPUUsage
        expr: sum(rate(container_cpu_usage_seconds_total[5m])) by (instance) &gt; 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &quot;High CPU usage detected&quot;
          description: &quot;CPU usage is above 80% for more than 5 minutes.&quot;</pre></div><div class='content'></div><h2>Configuració d'Alertmanager</h2>
<div class='content'><p>Alertmanager gestiona les alertes enviades per Prometheus i pot dirigir-les a diversos receptors com correu electrònic, Slack o PagerDuty.</p>
<ol>
<li>
<p><strong>Desplegar Alertmanager</strong>:</p>
<pre><code class="language-bash">helm install alertmanager prometheus-community/alertmanager
</code></pre>
</li>
<li>
<p><strong>Configurar Alertmanager</strong>:
Crea un fitxer de configuració (<code>alertmanager.yml</code>):</p>
<pre><code class="language-yaml">global:
  resolve_timeout: 5m

route:
  receiver: 'slack-notifications'

receivers:
  - name: 'slack-notifications'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX'
        channel: '#alerts'
</code></pre>
</li>
</ol>
</div><h1>Conclusió</h1>
<div class='content'><p>Monitorar un clúster de Kubernetes amb Prometheus implica configurar Prometheus, configurar-lo per recollir mètriques de diverses fonts, visualitzar aquestes mètriques amb Grafana i configurar alertes per notificar-te de qualsevol problema. Seguint els passos descrits en aquest tema, pots assegurar-te que el teu clúster de Kubernetes està ben monitorat i que se't notifica ràpidament de qualsevol problema potencial.</p>
</div></div>
		</div>
		<div class="col-12 col-lg-4 publi" id="div_publi">
			<h1>Publicitat</h1>
			<p>Aquest espai està destinat a publicitat.</p>
			<p>Si vols ser patrocinador, contacta amb nosaltres per incloure enllaços en aquesta zona: <a href='mailto:admin@campusempresa.cat'>admin@campusempresa.cat</a></p>
			<p>Gràcies per col·laborar!</p>
		</div>
	</div>
</div>

   <div class="container-xxl my-3">
	<div class="row">
		<div class="col">
			<footer>&copy; Copyright 2024. Tots els drets reservats</footer>
		</div>
	</div>
</div>	

<div id="cookies_adv">
	Fem servir galetes per millorar la teva experiència d'ús i oferir continguts adaptats als teus interessos
       <a href="#" id="btn_accept_cookies" class="button">Entès!</a>
       <a href="cookies">Més informació</a>
   </div>	
	</div>    
</body>
</html>
