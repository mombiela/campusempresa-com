<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sombreado Diferido</title>

    <link rel="alternate" href="https://campusempresa.com/mod/direct_x/07-01-deferred-shading" hreflang="es" />
	<link rel="alternate" href="https://campusempresa.cat/mod/direct_x/07-01-deferred-shading" hreflang="ca" />
	<link rel="alternate" href="https://enterprisecampus.net/mod/direct_x/07-01-deferred-shading" hreflang="en" />
    
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link href="/css/site.css" rel="stylesheet">
	
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  	<script type="text/javascript" src="js/math_init.js"></script>
  	<script type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"></script>
  	<script type="text/javascript" src="/js/cookie.js"></script>
  	<script type="text/javascript" src="/js/main.js"></script>
</head>

<body >
    <div id="content">
		<div id="header" class="container-xxl">
	<div class="row">
		<div class="col-12 col-md-8 p-0">
			<h1 class="m-0 p-0">
				<a href="/"><img src="/img/logo_header.png"></a>
			</h1>
		</div>
		<div class="col-12 col-md-4 p-0 text-end">
			<h2 id="main_title"><cite>Construyendo la sociedad de hoy y del mañana</cite></h2>
			<h3 id="main_subtitle"></h3>
		</div>
	</div>
</div>
<div class="container-xxl" style="margin-top: -1em;">
	<div class="row">
		<div class="col-12 p-0 m-0 text-end">
										<a href="https://enterprisecampus.net/mod/direct_x/07-01-deferred-shading" class="px-2">EN</a></b>
				|
				<b class="px-2">ES</b>
				|
				<a href="https://campusempresa.cat/mod/direct_x/07-01-deferred-shading" class="px-2">CA</a>
								</div>
	</div>
</div>
   <div class="top-bar container-fluid">
	<div class="container-xxl">
		<div class="row">
			<div class="col" id="left_menu">
				<a href="/objective">El Proyecto</a>
				<a href="/about">Sobre nosotros</a>
				<a href="/contribute">Contribuir</a>
				<a href="/donate">Donaciones</a>
				<a href="/licence">Licencia</a>
			</div>
		</div>
	</div>
   </div>

<div class="container-xxl" id="main_content">
	<div class="row">
		<div class="col-12 col-lg-8">
			<div id="nav1" class="navigation"></div>
			<div id="inner_content">
								<div class='row navigation'>
	<div class='col-2'>
					<a href='06-04-multithreading-directx' title="Multithreading en DirectX">&#x25C4;Anterior</a>
			</div>
	<div class='col-8 text-center'>
					<a href="./"><h2 style="text-decoration:underline">Sombreado Diferido</h2></a>
			</div>
	<div class='col-2 text-end'>
					<a href='07-02-post-processing-effects' title="Efectos de Post-Procesamiento">Siguiente &#x25BA;</a>
			</div>
</div>
<div class='content'><p>El sombreado diferido (Deferred Shading) es una técnica avanzada de renderizado que permite manejar múltiples luces de manera más eficiente que el sombreado directo (Forward Shading). En lugar de calcular la iluminación para cada píxel en el momento del renderizado, el sombreado diferido separa el proceso en dos fases: la fase de geometría y la fase de iluminación.</p>
</div><h1>Conceptos Clave</h1>
<div class='content'><ol>
<li>
<p><strong>Fase de Geometría</strong>:</p>
<ul>
<li>En esta fase, se renderizan las propiedades geométricas de la escena (posiciones, normales, colores, etc.) en varios render targets conocidos como G-buffers.</li>
</ul>
</li>
<li>
<p><strong>Fase de Iluminación</strong>:</p>
<ul>
<li>En esta fase, se utilizan los datos almacenados en los G-buffers para calcular la iluminación. Esto permite aplicar múltiples luces sin necesidad de renderizar la geometría de nuevo.</li>
</ul>
</li>
</ol>
</div><h1>Ventajas del Sombreado Diferido</h1>
<div class='content'><ul>
<li><strong>Eficiencia con Múltiples Luces</strong>: Permite manejar un gran número de luces sin un costo significativo en el rendimiento.</li>
<li><strong>Separación de Geometría e Iluminación</strong>: Facilita la implementación de efectos de iluminación complejos.</li>
</ul>
</div><h1>Desventajas del Sombreado Diferido</h1>
<div class='content'><ul>
<li><strong>Mayor Uso de Memoria</strong>: Los G-buffers pueden consumir una cantidad significativa de memoria.</li>
<li><strong>Compatibilidad con Transparencias</strong>: Manejar transparencias es más complicado en un pipeline de sombreado diferido.</li>
</ul>
</div><h1>Implementación del Sombreado Diferido</h1>
<div class='content'></div><h2>Paso 1: Configuración de los G-buffers</h2>
<div class='content'><p>Primero, necesitamos configurar varios render targets para almacenar las propiedades geométricas de la escena.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Ly8gQ3JlYXIgbG9zIEctYnVmZmVycwpJRDNEMTFUZXh0dXJlMkQqIGdCdWZmZXJUZXh0dXJlc1szXTsKSUQzRDExUmVuZGVyVGFyZ2V0VmlldyogZ0J1ZmZlclJUVnNbM107CklEM0QxMVNoYWRlclJlc291cmNlVmlldyogZ0J1ZmZlclNSVnNbM107Cgpmb3IgKGludCBpID0gMDsgaSA8IDM7ICsraSkgewogICAgRDNEMTFfVEVYVFVSRTJEX0RFU0MgdGV4dHVyZURlc2MgPSB7fTsKICAgIHRleHR1cmVEZXNjLldpZHRoID0gd2lkdGg7CiAgICB0ZXh0dXJlRGVzYy5IZWlnaHQgPSBoZWlnaHQ7CiAgICB0ZXh0dXJlRGVzYy5NaXBMZXZlbHMgPSAxOwogICAgdGV4dHVyZURlc2MuQXJyYXlTaXplID0gMTsKICAgIHRleHR1cmVEZXNjLkZvcm1hdCA9IERYR0lfRk9STUFUX1IzMkczMkIzMkEzMl9GTE9BVDsKICAgIHRleHR1cmVEZXNjLlNhbXBsZURlc2MuQ291bnQgPSAxOwogICAgdGV4dHVyZURlc2MuVXNhZ2UgPSBEM0QxMV9VU0FHRV9ERUZBVUxUOwogICAgdGV4dHVyZURlc2MuQmluZEZsYWdzID0gRDNEMTFfQklORF9SRU5ERVJfVEFSR0VUIHwgRDNEMTFfQklORF9TSEFERVJfUkVTT1VSQ0U7CgogICAgZGV2aWNlLT5DcmVhdGVUZXh0dXJlMkQoJnRleHR1cmVEZXNjLCBudWxscHRyLCAmZ0J1ZmZlclRleHR1cmVzW2ldKTsKICAgIGRldmljZS0+Q3JlYXRlUmVuZGVyVGFyZ2V0VmlldyhnQnVmZmVyVGV4dHVyZXNbaV0sIG51bGxwdHIsICZnQnVmZmVyUlRWc1tpXSk7CiAgICBkZXZpY2UtPkNyZWF0ZVNoYWRlclJlc291cmNlVmlldyhnQnVmZmVyVGV4dHVyZXNbaV0sIG51bGxwdHIsICZnQnVmZmVyU1JWc1tpXSk7Cn0="))));alert("¡Copiado!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>// Crear los G-buffers
ID3D11Texture2D* gBufferTextures[3];
ID3D11RenderTargetView* gBufferRTVs[3];
ID3D11ShaderResourceView* gBufferSRVs[3];

for (int i = 0; i &lt; 3; ++i) {
    D3D11_TEXTURE2D_DESC textureDesc = {};
    textureDesc.Width = width;
    textureDesc.Height = height;
    textureDesc.MipLevels = 1;
    textureDesc.ArraySize = 1;
    textureDesc.Format = DXGI_FORMAT_R32G32B32A32_FLOAT;
    textureDesc.SampleDesc.Count = 1;
    textureDesc.Usage = D3D11_USAGE_DEFAULT;
    textureDesc.BindFlags = D3D11_BIND_RENDER_TARGET | D3D11_BIND_SHADER_RESOURCE;

    device-&gt;CreateTexture2D(&amp;textureDesc, nullptr, &amp;gBufferTextures[i]);
    device-&gt;CreateRenderTargetView(gBufferTextures[i], nullptr, &amp;gBufferRTVs[i]);
    device-&gt;CreateShaderResourceView(gBufferTextures[i], nullptr, &amp;gBufferSRVs[i]);
}</pre></div><div class='content'></div><h2>Paso 2: Renderizado de la Fase de Geometría</h2>
<div class='content'><p>En esta fase, renderizamos la escena y almacenamos las propiedades geométricas en los G-buffers.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Ly8gRXN0YWJsZWNlciBsb3MgRy1idWZmZXJzIGNvbW8gcmVuZGVyIHRhcmdldHMKY29udGV4dC0+T01TZXRSZW5kZXJUYXJnZXRzKDMsIGdCdWZmZXJSVFZzLCBkZXB0aFN0ZW5jaWxWaWV3KTsKCi8vIFJlbmRlcml6YXIgbGEgZ2VvbWV0csOtYQpmb3IgKGF1dG8mIG9iamVjdCA6IHNjZW5lT2JqZWN0cykgewogICAgb2JqZWN0LlJlbmRlcihjb250ZXh0KTsKfQ=="))));alert("¡Copiado!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>// Establecer los G-buffers como render targets
context-&gt;OMSetRenderTargets(3, gBufferRTVs, depthStencilView);

// Renderizar la geometr&iacute;a
for (auto&amp; object : sceneObjects) {
    object.Render(context);
}</pre></div><div class='content'></div><h2>Paso 3: Renderizado de la Fase de Iluminación</h2>
<div class='content'><p>En esta fase, utilizamos los datos de los G-buffers para calcular la iluminación.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Ly8gRXN0YWJsZWNlciBlbCByZW5kZXIgdGFyZ2V0IGZpbmFsCmNvbnRleHQtPk9NU2V0UmVuZGVyVGFyZ2V0cygxLCAmZmluYWxSZW5kZXJUYXJnZXRWaWV3LCBudWxscHRyKTsKCi8vIEVzdGFibGVjZXIgbG9zIEctYnVmZmVycyBjb21vIHJlY3Vyc29zIGRlIHNoYWRlcgpjb250ZXh0LT5QU1NldFNoYWRlclJlc291cmNlcygwLCAzLCBnQnVmZmVyU1JWcyk7CgovLyBSZW5kZXJpemFyIGxhIGlsdW1pbmFjacOzbgpjb250ZXh0LT5EcmF3KDMsIDApOw=="))));alert("¡Copiado!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>// Establecer el render target final
context-&gt;OMSetRenderTargets(1, &amp;finalRenderTargetView, nullptr);

// Establecer los G-buffers como recursos de shader
context-&gt;PSSetShaderResources(0, 3, gBufferSRVs);

// Renderizar la iluminaci&oacute;n
context-&gt;Draw(3, 0);</pre></div><div class='content'></div><h2>Ejemplo de Shader para la Fase de Iluminación</h2>
<div class='content'><p>A continuación, se muestra un ejemplo de un pixel shader que utiliza los datos de los G-buffers para calcular la iluminación.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("VGV4dHVyZTJEPGZsb2F0ND4gZ0J1ZmZlcjAgOiByZWdpc3Rlcih0MCk7IC8vIFBvc2ljaW9uZXMKVGV4dHVyZTJEPGZsb2F0ND4gZ0J1ZmZlcjEgOiByZWdpc3Rlcih0MSk7IC8vIE5vcm1hbGVzClRleHR1cmUyRDxmbG9hdDQ+IGdCdWZmZXIyIDogcmVnaXN0ZXIodDIpOyAvLyBDb2xvcmVzCgpjYnVmZmVyIExpZ2h0QnVmZmVyIHsKICAgIGZsb2F0MyBsaWdodFBvc2l0aW9uOwogICAgZmxvYXQzIGxpZ2h0Q29sb3I7Cn07CgpmbG9hdDQgbWFpbihmbG9hdDQgcG9zaXRpb24gOiBTVl9QT1NJVElPTikgOiBTVl9UQVJHRVQgewogICAgZmxvYXQzIHdvcmxkUG9zID0gZ0J1ZmZlcjAuTG9hZChpbnQzKHBvc2l0aW9uLnh5LCAwKSkueHl6OwogICAgZmxvYXQzIG5vcm1hbCA9IG5vcm1hbGl6ZShnQnVmZmVyMS5Mb2FkKGludDMocG9zaXRpb24ueHksIDApKS54eXopOwogICAgZmxvYXQzIGNvbG9yID0gZ0J1ZmZlcjIuTG9hZChpbnQzKHBvc2l0aW9uLnh5LCAwKSkueHl6OwoKICAgIGZsb2F0MyBsaWdodERpciA9IG5vcm1hbGl6ZShsaWdodFBvc2l0aW9uIC0gd29ybGRQb3MpOwogICAgZmxvYXQgTmRvdEwgPSBtYXgoZG90KG5vcm1hbCwgbGlnaHREaXIpLCAwLjApOwoKICAgIGZsb2F0MyBkaWZmdXNlID0gTmRvdEwgKiBsaWdodENvbG9yICogY29sb3I7CgogICAgcmV0dXJuIGZsb2F0NChkaWZmdXNlLCAxLjApOwp9"))));alert("¡Copiado!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>Texture2D&lt;float4&gt; gBuffer0 : register(t0); // Posiciones
Texture2D&lt;float4&gt; gBuffer1 : register(t1); // Normales
Texture2D&lt;float4&gt; gBuffer2 : register(t2); // Colores

cbuffer LightBuffer {
    float3 lightPosition;
    float3 lightColor;
};

float4 main(float4 position : SV_POSITION) : SV_TARGET {
    float3 worldPos = gBuffer0.Load(int3(position.xy, 0)).xyz;
    float3 normal = normalize(gBuffer1.Load(int3(position.xy, 0)).xyz);
    float3 color = gBuffer2.Load(int3(position.xy, 0)).xyz;

    float3 lightDir = normalize(lightPosition - worldPos);
    float NdotL = max(dot(normal, lightDir), 0.0);

    float3 diffuse = NdotL * lightColor * color;

    return float4(diffuse, 1.0);
}</pre></div><div class='content'></div><h1>Ejercicio Práctico</h1>
<div class='content'></div><h2>Ejercicio</h2>
<div class='content'><ol>
<li>Configura los G-buffers para almacenar las posiciones, normales y colores de la escena.</li>
<li>Implementa la fase de geometría para renderizar las propiedades geométricas en los G-buffers.</li>
<li>Implementa la fase de iluminación para calcular la iluminación utilizando los datos de los G-buffers.</li>
</ol>
</div><h2>Solución</h2>
<div class='content'><ol>
<li><strong>Configuración de los G-buffers</strong>: Ver el código en el Paso 1.</li>
<li><strong>Renderizado de la Fase de Geometría</strong>: Ver el código en el Paso 2.</li>
<li><strong>Renderizado de la Fase de Iluminación</strong>: Ver el código en el Paso 3 y el shader de ejemplo.</li>
</ol>
</div><h1>Conclusión</h1>
<div class='content'><p>El sombreado diferido es una técnica poderosa para manejar escenas con múltiples luces de manera eficiente. Aunque tiene algunas desventajas, como el mayor uso de memoria y la complejidad en el manejo de transparencias, sus beneficios en términos de rendimiento y flexibilidad lo hacen una opción atractiva para aplicaciones gráficas avanzadas. En el siguiente tema, exploraremos los efectos de post-procesamiento, que pueden ser utilizados para mejorar aún más la calidad visual de nuestras aplicaciones DirectX.</p>
</div><div class='row navigation'>
	<div class='col-2'>
					<a href='06-04-multithreading-directx' title="Multithreading en DirectX">&#x25C4;Anterior</a>
			</div>
	<div class='col-8 text-center'>
			</div>
	<div class='col-2 text-end'>
					<a href='07-02-post-processing-effects' title="Efectos de Post-Procesamiento">Siguiente &#x25BA;</a>
			</div>
</div>

			</div>
		</div>
		<div class="col-12 col-lg-4 publi" id="div_publi">
			<h1>Publicidad</h1>
			<p>Este espacio está destinado a publicidad.</p>
			<p>Si quieres ser patrocinador, contáctanos para incluir enlaces en esta zona: <a href='mailto:admin@campusempresa.cat'>admin@campusempresa.cat</a></p>
			<p>¡Gracias por colaborar!</p>
		</div>
	</div>
</div>

   <div class="container-xxl my-3">
	<div class="row">
		<div class="col">
			<footer>&copy; Copyright 2024. Todos los derechos reservados</footer>
		</div>
	</div>
</div>	

<div id="cookies_adv" style="display:none;">
	Fem servir galetes per millorar la teva experiència d'ús i oferir continguts adaptats als teus interessos
    <a href="#" id="btn_accept_cookies" class="button">Aceptar</a>
    <a href="/cookies">Mas información</a>
</div>	

	</div>    
</body>
</html>
