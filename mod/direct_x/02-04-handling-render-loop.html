<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manejando el Bucle de Renderizado</title>

    <link rel="alternate" href="https://campusempresa.com/mod/direct_x/02-04-handling-render-loop" hreflang="es" />
	<link rel="alternate" href="https://campusempresa.cat/mod/direct_x/02-04-handling-render-loop" hreflang="ca" />
	<link rel="alternate" href="https://enterprisecampus.net/mod/direct_x/02-04-handling-render-loop" hreflang="en" />
    
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link href="/css/site.css" rel="stylesheet">
	
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  	<script type="text/javascript" src="/js/math_init.js"></script>
  	<script type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"></script>
  	<script type="text/javascript" src="/js/cookie.js"></script>
  	<script type="text/javascript" src="/js/main.js"></script>
</head>

<body >
    <div id="content">
		<div id="header" class="container-xxl">
	<div class="row">
		<div class="col-12 col-md-8 p-0">
			<h1 class="m-0 p-0">
				<a href="/"><img src="/img/logo_header.png"></a>
			</h1>
		</div>
		<div class="col-12 col-md-4 px-0 py-2 py-md-0 text-end">
			<h2 id="main_title"><cite>Construyendo la sociedad de hoy y del mañana</cite></h2>
			<h3 id="main_subtitle"></h3>
		</div>
	</div>
</div>
<div class="container-xxl" style="margin-top: -1em;">
	<div class="row">
		<div class="col-12 px-0 py-2 py-md-0 m-0 text-end">
										<a href="https://enterprisecampus.net/mod/direct_x/02-04-handling-render-loop" class="px-2">EN</a></b>
				|
				<b class="px-2">ES</b>
				|
				<a href="https://campusempresa.cat/mod/direct_x/02-04-handling-render-loop" class="px-2">CA</a>
								</div>
	</div>
</div>
   <div class="top-bar container-fluid">
	<div class="container-xxl">
		<div class="row">
			<div class="col" id="left_menu">
				<a href="/objective">El Proyecto</a>
				<a href="/about">Sobre nosotros</a>
				<a href="/contribute">Contribuir</a>
				<a href="/donate">Donaciones</a>
				<a href="/licence">Licencia</a>
			</div>
		</div>
	</div>
   </div>

<div class="container-xxl" id="main_content">
	<div class="row">
		<div class="col-12 col-lg-8">
			<div id="nav1" class="navigation"></div>
			<div id="inner_content">
								<div class='row navigation'>
	<div class='col-2'>
					<a href='02-03-rendering-a-triangle' title="Renderizando un Triángulo">&#x25C4;Anterior</a>
			</div>
	<div class='col-8 text-center'>
					<a href="./"><h2 style="text-decoration:underline">Manejando el Bucle de Renderizado</h2></a>
			</div>
	<div class='col-2 text-end'>
					<a href='03-01-introduction-to-shaders' title="Introducción a los Shaders">Siguiente &#x25BA;</a>
			</div>
</div>
<div class='content'><p>En este tema, aprenderemos cómo manejar el bucle de renderizado en una aplicación DirectX. El bucle de renderizado es el corazón de cualquier aplicación gráfica en tiempo real, ya que es responsable de actualizar y renderizar la escena continuamente.</p>
</div><h1>Conceptos Clave</h1>
<div class='content'><ol>
<li><strong>Bucle de Renderizado</strong>: Es un ciclo continuo que actualiza y dibuja la escena en la pantalla.</li>
<li><strong>Mensajería de Windows</strong>: Mecanismo para manejar eventos del sistema operativo.</li>
<li><strong>Temporización</strong>: Control del tiempo para asegurar que la aplicación se ejecute a una velocidad constante.</li>
</ol>
</div><h1>Estructura del Bucle de Renderizado</h1>
<div class='content'><p>El bucle de renderizado generalmente sigue estos pasos:</p>
<ol>
<li><strong>Procesar Mensajes de Windows</strong>: Manejar eventos como entrada del teclado y ratón.</li>
<li><strong>Actualizar la Lógica del Juego</strong>: Actualizar la posición de los objetos, manejar colisiones, etc.</li>
<li><strong>Renderizar la Escena</strong>: Dibujar los objetos en la pantalla.</li>
</ol>
</div><h2>Ejemplo de Código</h2>
<div class='content'><p>A continuación, se muestra un ejemplo básico de un bucle de renderizado en una aplicación DirectX:</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("I2luY2x1ZGUgPHdpbmRvd3MuaD4KI2luY2x1ZGUgPGQzZDExLmg+CgovLyBWYXJpYWJsZXMgZ2xvYmFsZXMKSFdORCBod25kID0gbnVsbHB0cjsKSUQzRDExRGV2aWNlKiBkZXZpY2UgPSBudWxscHRyOwpJRDNEMTFEZXZpY2VDb250ZXh0KiBjb250ZXh0ID0gbnVsbHB0cjsKSURYR0lTd2FwQ2hhaW4qIHN3YXBDaGFpbiA9IG51bGxwdHI7CklEM0QxMVJlbmRlclRhcmdldFZpZXcqIHJlbmRlclRhcmdldFZpZXcgPSBudWxscHRyOwoKLy8gUHJvdG90aXBvcyBkZSBmdW5jaW9uZXMKTFJFU1VMVCBDQUxMQkFDSyBXaW5kb3dQcm9jKEhXTkQgaHduZCwgVUlOVCB1TXNnLCBXUEFSQU0gd1BhcmFtLCBMUEFSQU0gbFBhcmFtKTsKdm9pZCBJbml0RDNEKEhXTkQgaHduZCk7CnZvaWQgQ2xlYW5EM0QoKTsKdm9pZCBSZW5kZXJGcmFtZSgpOwoKaW50IFdJTkFQSSBXaW5NYWluKEhJTlNUQU5DRSBoSW5zdGFuY2UsIEhJTlNUQU5DRSBoUHJldkluc3RhbmNlLCBMUFNUUiBscENtZExpbmUsIGludCBuQ21kU2hvdykgewogICAgLy8gQ3JlYXIgdmVudGFuYQogICAgV05EQ0xBU1NFWCB3YyA9IHsgc2l6ZW9mKFdORENMQVNTRVgpLCBDU19DTEFTU0RDLCBXaW5kb3dQcm9jLCAwTCwgMEwsIEdldE1vZHVsZUhhbmRsZShOVUxMKSwgTlVMTCwgTlVMTCwgTlVMTCwgTlVMTCwgX1QoIkRpcmVjdFhFeGFtcGxlIiksIE5VTEwgfTsKICAgIFJlZ2lzdGVyQ2xhc3NFeCgmd2MpOwogICAgaHduZCA9IENyZWF0ZVdpbmRvdyh3Yy5scHN6Q2xhc3NOYW1lLCBfVCgiRGlyZWN0WCBFeGFtcGxlIiksIFdTX09WRVJMQVBQRURXSU5ET1csIDEwMCwgMTAwLCA4MDAsIDYwMCwgTlVMTCwgTlVMTCwgd2MuaEluc3RhbmNlLCBOVUxMKTsKCiAgICAvLyBJbmljaWFsaXphciBEaXJlY3QzRAogICAgSW5pdEQzRChod25kKTsKCiAgICAvLyBNb3N0cmFyIHZlbnRhbmEKICAgIFNob3dXaW5kb3coaHduZCwgbkNtZFNob3cpOwogICAgVXBkYXRlV2luZG93KGh3bmQpOwoKICAgIC8vIEJ1Y2xlIGRlIG1lbnNhamVzIHkgcmVuZGVyaXphZG8KICAgIE1TRyBtc2cgPSB7IDAgfTsKICAgIHdoaWxlIChtc2cubWVzc2FnZSAhPSBXTV9RVUlUKSB7CiAgICAgICAgaWYgKFBlZWtNZXNzYWdlKCZtc2csIE5VTEwsIDBVLCAwVSwgUE1fUkVNT1ZFKSkgewogICAgICAgICAgICBUcmFuc2xhdGVNZXNzYWdlKCZtc2cpOwogICAgICAgICAgICBEaXNwYXRjaE1lc3NhZ2UoJm1zZyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgUmVuZGVyRnJhbWUoKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gTGltcGlhciBEaXJlY3QzRAogICAgQ2xlYW5EM0QoKTsKCiAgICBVbnJlZ2lzdGVyQ2xhc3Mod2MubHBzekNsYXNzTmFtZSwgd2MuaEluc3RhbmNlKTsKICAgIHJldHVybiAwOwp9CgpMUkVTVUxUIENBTExCQUNLIFdpbmRvd1Byb2MoSFdORCBod25kLCBVSU5UIHVNc2csIFdQQVJBTSB3UGFyYW0sIExQQVJBTSBsUGFyYW0pIHsKICAgIHN3aXRjaCAodU1zZykgewogICAgICAgIGNhc2UgV01fREVTVFJPWToKICAgICAgICAgICAgUG9zdFF1aXRNZXNzYWdlKDApOwogICAgICAgICAgICByZXR1cm4gMDsKICAgIH0KICAgIHJldHVybiBEZWZXaW5kb3dQcm9jKGh3bmQsIHVNc2csIHdQYXJhbSwgbFBhcmFtKTsKfQoKdm9pZCBJbml0RDNEKEhXTkQgaHduZCkgewogICAgLy8gQ3JlYXIgZGlzcG9zaXRpdm8geSBjb250ZXh0bwogICAgRDNEMTFDcmVhdGVEZXZpY2VBbmRTd2FwQ2hhaW4oTlVMTCwgRDNEX0RSSVZFUl9UWVBFX0hBUkRXQVJFLCBOVUxMLCAwLCBOVUxMLCAwLCBEM0QxMV9TREtfVkVSU0lPTiwgJnN3YXBDaGFpbkRlc2MsICZzd2FwQ2hhaW4sICZkZXZpY2UsIE5VTEwsICZjb250ZXh0KTsKCiAgICAvLyBDcmVhciByZW5kZXIgdGFyZ2V0IHZpZXcKICAgIElEM0QxMVRleHR1cmUyRCogYmFja0J1ZmZlcjsKICAgIHN3YXBDaGFpbi0+R2V0QnVmZmVyKDAsIF9fdXVpZG9mKElEM0QxMVRleHR1cmUyRCksIChMUFZPSUQqKSZiYWNrQnVmZmVyKTsKICAgIGRldmljZS0+Q3JlYXRlUmVuZGVyVGFyZ2V0VmlldyhiYWNrQnVmZmVyLCBOVUxMLCAmcmVuZGVyVGFyZ2V0Vmlldyk7CiAgICBiYWNrQnVmZmVyLT5SZWxlYXNlKCk7CgogICAgY29udGV4dC0+T01TZXRSZW5kZXJUYXJnZXRzKDEsICZyZW5kZXJUYXJnZXRWaWV3LCBOVUxMKTsKCiAgICAvLyBDb25maWd1cmFyIHZpZXdwb3J0CiAgICBEM0QxMV9WSUVXUE9SVCB2aWV3cG9ydCA9IHsgMC4wZiwgMC4wZiwgODAwLjBmLCA2MDAuMGYsIDAuMGYsIDEuMGYgfTsKICAgIGNvbnRleHQtPlJTU2V0Vmlld3BvcnRzKDEsICZ2aWV3cG9ydCk7Cn0KCnZvaWQgQ2xlYW5EM0QoKSB7CiAgICBzd2FwQ2hhaW4tPlJlbGVhc2UoKTsKICAgIHJlbmRlclRhcmdldFZpZXctPlJlbGVhc2UoKTsKICAgIGNvbnRleHQtPlJlbGVhc2UoKTsKICAgIGRldmljZS0+UmVsZWFzZSgpOwp9Cgp2b2lkIFJlbmRlckZyYW1lKCkgewogICAgLy8gTGltcGlhciBlbCBiYWNrIGJ1ZmZlcgogICAgZmxvYXQgY29sb3JbNF0gPSB7IDAuMGYsIDAuMmYsIDAuNGYsIDEuMGYgfTsKICAgIGNvbnRleHQtPkNsZWFyUmVuZGVyVGFyZ2V0VmlldyhyZW5kZXJUYXJnZXRWaWV3LCBjb2xvcik7CgogICAgLy8gUHJlc2VudGFyIGVsIGJhY2sgYnVmZmVyCiAgICBzd2FwQ2hhaW4tPlByZXNlbnQoMCwgMCk7Cn0="))));alert("¡Copiado!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>#include &lt;windows.h&gt;
#include &lt;d3d11.h&gt;

// Variables globales
HWND hwnd = nullptr;
ID3D11Device* device = nullptr;
ID3D11DeviceContext* context = nullptr;
IDXGISwapChain* swapChain = nullptr;
ID3D11RenderTargetView* renderTargetView = nullptr;

// Prototipos de funciones
LRESULT CALLBACK WindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam);
void InitD3D(HWND hwnd);
void CleanD3D();
void RenderFrame();

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
    // Crear ventana
    WNDCLASSEX wc = { sizeof(WNDCLASSEX), CS_CLASSDC, WindowProc, 0L, 0L, GetModuleHandle(NULL), NULL, NULL, NULL, NULL, _T(&quot;DirectXExample&quot;), NULL };
    RegisterClassEx(&amp;wc);
    hwnd = CreateWindow(wc.lpszClassName, _T(&quot;DirectX Example&quot;), WS_OVERLAPPEDWINDOW, 100, 100, 800, 600, NULL, NULL, wc.hInstance, NULL);

    // Inicializar Direct3D
    InitD3D(hwnd);

    // Mostrar ventana
    ShowWindow(hwnd, nCmdShow);
    UpdateWindow(hwnd);

    // Bucle de mensajes y renderizado
    MSG msg = { 0 };
    while (msg.message != WM_QUIT) {
        if (PeekMessage(&amp;msg, NULL, 0U, 0U, PM_REMOVE)) {
            TranslateMessage(&amp;msg);
            DispatchMessage(&amp;msg);
        } else {
            RenderFrame();
        }
    }

    // Limpiar Direct3D
    CleanD3D();

    UnregisterClass(wc.lpszClassName, wc.hInstance);
    return 0;
}

LRESULT CALLBACK WindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam) {
    switch (uMsg) {
        case WM_DESTROY:
            PostQuitMessage(0);
            return 0;
    }
    return DefWindowProc(hwnd, uMsg, wParam, lParam);
}

void InitD3D(HWND hwnd) {
    // Crear dispositivo y contexto
    D3D11CreateDeviceAndSwapChain(NULL, D3D_DRIVER_TYPE_HARDWARE, NULL, 0, NULL, 0, D3D11_SDK_VERSION, &amp;swapChainDesc, &amp;swapChain, &amp;device, NULL, &amp;context);

    // Crear render target view
    ID3D11Texture2D* backBuffer;
    swapChain-&gt;GetBuffer(0, __uuidof(ID3D11Texture2D), (LPVOID*)&amp;backBuffer);
    device-&gt;CreateRenderTargetView(backBuffer, NULL, &amp;renderTargetView);
    backBuffer-&gt;Release();

    context-&gt;OMSetRenderTargets(1, &amp;renderTargetView, NULL);

    // Configurar viewport
    D3D11_VIEWPORT viewport = { 0.0f, 0.0f, 800.0f, 600.0f, 0.0f, 1.0f };
    context-&gt;RSSetViewports(1, &amp;viewport);
}

void CleanD3D() {
    swapChain-&gt;Release();
    renderTargetView-&gt;Release();
    context-&gt;Release();
    device-&gt;Release();
}

void RenderFrame() {
    // Limpiar el back buffer
    float color[4] = { 0.0f, 0.2f, 0.4f, 1.0f };
    context-&gt;ClearRenderTargetView(renderTargetView, color);

    // Presentar el back buffer
    swapChain-&gt;Present(0, 0);
}</pre></div><div class='content'></div><h2>Explicación del Código</h2>
<div class='content'><ol>
<li>
<p><strong>Inicialización de Direct3D</strong>:</p>
<ul>
<li><code>InitD3D(HWND hwnd)</code>: Configura el dispositivo Direct3D, el contexto y el swap chain.</li>
<li><code>D3D11CreateDeviceAndSwapChain</code>: Crea el dispositivo y el swap chain.</li>
<li><code>CreateRenderTargetView</code>: Crea la vista del render target.</li>
</ul>
</li>
<li>
<p><strong>Bucle de Mensajes y Renderizado</strong>:</p>
<ul>
<li><code>PeekMessage</code>: Verifica si hay mensajes en la cola de mensajes.</li>
<li><code>TranslateMessage</code> y <code>DispatchMessage</code>: Procesan los mensajes de Windows.</li>
<li><code>RenderFrame</code>: Llama a la función de renderizado si no hay mensajes.</li>
</ul>
</li>
<li>
<p><strong>Renderizado</strong>:</p>
<ul>
<li><code>ClearRenderTargetView</code>: Limpia el back buffer con un color específico.</li>
<li><code>Present</code>: Presenta el back buffer en la pantalla.</li>
</ul>
</li>
</ol>
</div><h2>Ejercicio Práctico</h2>
<div class='content'><p><strong>Ejercicio</strong>: Modifica el código anterior para que el color de fondo cambie gradualmente con el tiempo.</p>
<p><strong>Solución</strong>:</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("dm9pZCBSZW5kZXJGcmFtZSgpIHsKICAgIC8vIENhbGN1bGFyIGVsIGNvbG9yIGJhc2FkbyBlbiBlbCB0aWVtcG8KICAgIHN0YXRpYyBmbG9hdCB0ID0gMC4wZjsKICAgIHQgKz0gMC4wMWY7CiAgICBmbG9hdCBjb2xvcls0XSA9IHsgKHNpbih0KSArIDEuMGYpIC8gMi4wZiwgKGNvcyh0KSArIDEuMGYpIC8gMi4wZiwgMC40ZiwgMS4wZiB9OwoKICAgIC8vIExpbXBpYXIgZWwgYmFjayBidWZmZXIKICAgIGNvbnRleHQtPkNsZWFyUmVuZGVyVGFyZ2V0VmlldyhyZW5kZXJUYXJnZXRWaWV3LCBjb2xvcik7CgogICAgLy8gUHJlc2VudGFyIGVsIGJhY2sgYnVmZmVyCiAgICBzd2FwQ2hhaW4tPlByZXNlbnQoMCwgMCk7Cn0="))));alert("¡Copiado!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>void RenderFrame() {
    // Calcular el color basado en el tiempo
    static float t = 0.0f;
    t += 0.01f;
    float color[4] = { (sin(t) + 1.0f) / 2.0f, (cos(t) + 1.0f) / 2.0f, 0.4f, 1.0f };

    // Limpiar el back buffer
    context-&gt;ClearRenderTargetView(renderTargetView, color);

    // Presentar el back buffer
    swapChain-&gt;Present(0, 0);
}</pre></div><div class='content'></div><h2>Errores Comunes y Consejos</h2>
<div class='content'><ol>
<li><strong>No Procesar Mensajes de Windows</strong>: Asegúrate de que <code>PeekMessage</code> y <code>DispatchMessage</code> se llamen correctamente para evitar que la aplicación se congele.</li>
<li><strong>No Liberar Recursos</strong>: Siempre libera los recursos de Direct3D en <code>CleanD3D</code> para evitar fugas de memoria.</li>
<li><strong>Sincronización de Fotogramas</strong>: Usa <code>swapChain-&gt;Present(1, 0)</code> para habilitar V-Sync y evitar el tearing de la pantalla.</li>
</ol>
</div><h1>Conclusión</h1>
<div class='content'><p>En esta sección, hemos aprendido cómo manejar el bucle de renderizado en una aplicación DirectX. Hemos cubierto la estructura básica del bucle, cómo inicializar Direct3D, y cómo renderizar un frame. Además, hemos visto un ejercicio práctico para reforzar los conceptos aprendidos. En el próximo módulo, profundizaremos en el uso de shaders para mejorar la calidad visual de nuestras aplicaciones.</p>
</div><div class='row navigation'>
	<div class='col-2'>
					<a href='02-03-rendering-a-triangle' title="Renderizando un Triángulo">&#x25C4;Anterior</a>
			</div>
	<div class='col-8 text-center'>
			</div>
	<div class='col-2 text-end'>
					<a href='03-01-introduction-to-shaders' title="Introducción a los Shaders">Siguiente &#x25BA;</a>
			</div>
</div>

			</div>
		</div>
		<div class="col-12 col-lg-4 publi" id="div_publi">
			<h1>Publicidad</h1>
			<p>Este espacio está destinado a publicidad.</p>
			<p>Si quieres ser patrocinador, contáctanos para incluir enlaces en esta zona: <a href='mailto:admin@campusempresa.cat'>admin@campusempresa.cat</a></p>
			<p>¡Gracias por colaborar!</p>
		</div>
	</div>
</div>

   <div class="container-xxl my-3">
	<div class="row">
		<div class="col">
			<footer>&copy; Copyright 2024. Todos los derechos reservados</footer>
		</div>
	</div>
</div>	

<div id="cookies_adv" style="display:none;">
	Fem servir galetes per millorar la teva experiència d'ús i oferir continguts adaptats als teus interessos
    <a href="#" id="btn_accept_cookies" class="button">Aceptar</a>
    <a href="/cookies">Mas información</a>
</div>	

	</div>    
</body>
</html>
