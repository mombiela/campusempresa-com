<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo con Prometheus</title>

    <link rel="alternate" href="https://campusempresa.com/mod/kubernetes/monitoring-with-prometheus" hreflang="es" />
	<link rel="alternate" href="https://campusempresa.cat/mod/kubernetes/monitoring-with-prometheus" hreflang="ca" />
	<link rel="alternate" href="https://enterprisecampus.net/mod/kubernetes/monitoring-with-prometheus" hreflang="en" />
    
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link href="/css/site.css" rel="stylesheet">
	
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  	<script type="text/javascript" src="js/math_init.js"></script>
  	<script type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"></script>
  	<script type="text/javascript" src="/js/cookie.js"></script>
  	<script type="text/javascript" src="/js/main.js"></script>
</head>

<body>
    <div id="content">
		<div id="header" class="container-xxl">
	<div class="row">
		<div class="col-8 p-0">
			<h1 class="m-0 p-0">
				<a href="/"><img src="/img/logo_header.png"></a>
			</h1>
		</div>
		<div class="col-4 p-0 text-end">
			<h2 id="main_title"><cite>Construyendo la sociedad de hoy y del mañana</cite></h2>
			<h3 id="main_subtitle"></h3>
		</div>
	</div>
</div>
<div class="container-xxl" style="margin-top: -1em;">
	<div class="row">
		<div class="col-12 p-0 m-0 text-end">
										<a href="https://enterprisecampus.net/mod/kubernetes/monitoring-with-prometheus" class="px-2">EN</a></b>
				|
				<b class="px-2">ES</b>
				|
				<a href="https://campusempresa.cat/mod/kubernetes/monitoring-with-prometheus" class="px-2">CA</a>
								</div>
	</div>
</div>
   <div class="top-bar container-fluid">
	<div class="container-xxl">
		<div class="row">
			<div class="col" id="left_menu">
				<a href="/objective">El Proyecto</a>
				<a href="/about">Sobre nosotros</a>
				<a href="/contribute">Contribuir</a>
				<a href="/donate">Donaciones</a>
				<a href="/licence">Licencia</a>
			</div>
		</div>
	</div>
   </div>

<div class="container-xxl" id="main_content">
	<div class="row">
		<div class="col-12 col-lg-8">
			<div id="nav1" class="navigation"></div>
			<div id="inner_content"><div class='row navigation'>
	<div class='col-4'>
					<a href='kubernetes-api-and-kubectl'>&#x25C4;API de Kubernetes y kubectl</a>
			</div>
	<div class='col-4 text-center'>
		<a href="./" class="title">Monitoreo con Prometheus</a>
	</div>
	<div class='col-4 text-end'>
					<a href='logging-with-efk'>Registro con Elasticsearch, Fluentd y Kibana (EFK) &#x25BA;</a>
			</div>
</div>
<div class='content'></div><h1>Introducción a Prometheus</h1>
<div class='content'><p>Prometheus es una herramienta de monitoreo y alerta de sistemas de código abierto, originalmente construida en SoundCloud. Desde su creación, se ha convertido en una opción popular para monitorear clústeres de Kubernetes debido a su poderoso lenguaje de consulta, modelo de datos flexible e integración perfecta con Kubernetes.</p>
</div><h2>Conceptos Clave</h2>
<div class='content'><ul>
<li><strong>Base de Datos de Series Temporales</strong>: Prometheus almacena todos los datos como series temporales, que son flujos de valores con marcas de tiempo pertenecientes a la misma métrica y conjunto de dimensiones etiquetadas.</li>
<li><strong>Métricas</strong>: Estos son los puntos de datos fundamentales recopilados por Prometheus. Las métricas pueden ser contadores, medidores, histogramas o resúmenes.</li>
<li><strong>Etiquetas</strong>: Las etiquetas son pares clave-valor que se adjuntan a las métricas para agregar dimensiones a ellas.</li>
<li><strong>PromQL</strong>: Lenguaje de Consulta de Prometheus utilizado para consultar los datos de series temporales.</li>
<li><strong>Alertmanager</strong>: Un componente que maneja las alertas enviadas por Prometheus.</li>
</ul>
</div><h1>Configuración de Prometheus en Kubernetes</h1>
<div class='content'><p>Para monitorear un clúster de Kubernetes con Prometheus, necesitas desplegar Prometheus, configurarlo para recopilar métricas de tus componentes de Kubernetes y configurar tableros y alertas.</p>
</div><h2>Desplegando Prometheus</h2>
<div class='content'><p>Puedes desplegar Prometheus usando Helm, un gestor de paquetes para Kubernetes.</p>
<ol>
<li>
<p><strong>Instalar Helm</strong>:</p>
<pre><code class="language-bash">curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
</code></pre>
</li>
<li>
<p><strong>Agregar el Repositorio Helm de Prometheus</strong>:</p>
<pre><code class="language-bash">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
</code></pre>
</li>
<li>
<p><strong>Instalar Prometheus</strong>:</p>
<pre><code class="language-bash">helm install prometheus prometheus-community/prometheus
</code></pre>
</li>
</ol>
</div><h2>Configurando Prometheus</h2>
<div class='content'><p>La configuración de Prometheus se realiza utilizando un archivo YAML. A continuación, se muestra un ejemplo básico de un archivo de configuración de Prometheus (<code>prometheus.yml</code>):</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Z2xvYmFsOgogIHNjcmFwZV9pbnRlcnZhbDogMTVzCgpzY3JhcGVfY29uZmlnczoKICAtIGpvYl9uYW1lOiAna3ViZXJuZXRlcy1hcGlzZXJ2ZXJzJwogICAga3ViZXJuZXRlc19zZF9jb25maWdzOgogICAgICAtIHJvbGU6IGVuZHBvaW50cwogICAgcmVsYWJlbF9jb25maWdzOgogICAgICAtIHNvdXJjZV9sYWJlbHM6IFtfX21ldGFfa3ViZXJuZXRlc19uYW1lc3BhY2UsIF9fbWV0YV9rdWJlcm5ldGVzX3NlcnZpY2VfbmFtZSwgX19tZXRhX2t1YmVybmV0ZXNfZW5kcG9pbnRfcG9ydF9uYW1lXQogICAgICAgIGFjdGlvbjoga2VlcAogICAgICAgIHJlZ2V4OiBkZWZhdWx0O2t1YmVybmV0ZXM7aHR0cHM="))));alert("¡Copiado!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'kubernetes-apiservers'
    kubernetes_sd_configs:
      - role: endpoints
    relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https</pre></div><div class='content'></div><h2>Recopilación de Métricas</h2>
<div class='content'><p>Prometheus recopila métricas de varios puntos finales. En un entorno de Kubernetes, estos puntos finales a menudo son expuestos por servicios.</p>
<ul>
<li><strong>Node Exporter</strong>: Recopila métricas de hardware y del sistema operativo.</li>
<li><strong>Kube-State-Metrics</strong>: Expone métricas del estado del clúster de Kubernetes.</li>
<li><strong>cAdvisor</strong>: Proporciona métricas de uso de recursos y rendimiento de contenedores.</li>
</ul>
</div><h2>Ejemplo: Recopilación de Métricas de Nodo</h2>
<div class='content'><p>Para recopilar métricas de nodo, necesitas desplegar el Node Exporter y configurar Prometheus para recopilar sus métricas.</p>
<ol>
<li>
<p><strong>Desplegar Node Exporter</strong>:</p>
<pre><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/prometheus/node_exporter/main/examples/node-exporter-daemonset.yaml
</code></pre>
</li>
<li>
<p><strong>Configurar Prometheus para Recopilar Node Exporter</strong>:</p>
<pre><code class="language-yaml">scrape_configs:
  - job_name: 'node-exporter'
    kubernetes_sd_configs:
      - role: node
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:9100
      - source_labels: [__address__]
        target_label: instance
</code></pre>
</li>
</ol>
</div><h1>Visualización de Métricas con Grafana</h1>
<div class='content'><p>Grafana es una plataforma popular de código abierto para monitoreo y observabilidad. Se integra perfectamente con Prometheus para visualizar métricas.</p>
</div><h2>Desplegando Grafana</h2>
<div class='content'><ol>
<li>
<p><strong>Instalar Grafana usando Helm</strong>:</p>
<pre><code class="language-bash">helm install grafana grafana/grafana
</code></pre>
</li>
<li>
<p><strong>Acceder a Grafana</strong>:</p>
<pre><code class="language-bash">kubectl port-forward service/grafana 3000:80
</code></pre>
</li>
<li>
<p><strong>Agregar Prometheus como Fuente de Datos</strong>:</p>
<ul>
<li>Abre Grafana en tu navegador en <code>http://localhost:3000</code>.</li>
<li>Ve a Configuración &gt; Fuentes de Datos &gt; Agregar fuente de datos.</li>
<li>Selecciona Prometheus e ingresa la URL de tu servidor Prometheus (por ejemplo, <code>http://prometheus-server</code>).</li>
</ul>
</li>
</ol>
</div><h2>Creación de Tableros</h2>
<div class='content'><p>Grafana te permite crear tableros personalizados para visualizar tus métricas.</p>
<ol>
<li>
<p><strong>Crear un Nuevo Tablero</strong>:</p>
<ul>
<li>Haz clic en el icono &quot;+&quot; en la barra lateral izquierda y selecciona &quot;Dashboard&quot;.</li>
<li>Haz clic en &quot;Add new panel&quot;.</li>
<li>Usa PromQL para consultar tus métricas y visualizarlas.</li>
</ul>
<p>Ejemplo de consulta PromQL para monitorear el uso de CPU:</p>
<pre><code class="language-promql">sum(rate(container_cpu_usage_seconds_total[5m])) by (instance)
</code></pre>
</li>
</ol>
</div><h1>Configuración de Alertas</h1>
<div class='content'><p>Prometheus puede enviar alertas basadas en las métricas que recopila. Las alertas se definen en el archivo de configuración de Prometheus.</p>
</div><h2>Ejemplo de Regla de Alerta</h2>
<div class='content'><p>A continuación, se muestra un ejemplo de una regla de alerta que se activa si el uso de CPU está por encima del 80% durante más de 5 minutos:</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Z3JvdXBzOgogIC0gbmFtZTogZXhhbXBsZQogICAgcnVsZXM6CiAgICAgIC0gYWxlcnQ6IEhpZ2hDUFVVc2FnZQogICAgICAgIGV4cHI6IHN1bShyYXRlKGNvbnRhaW5lcl9jcHVfdXNhZ2Vfc2Vjb25kc190b3RhbFs1bV0pKSBieSAoaW5zdGFuY2UpID4gMC44CiAgICAgICAgZm9yOiA1bQogICAgICAgIGxhYmVsczoKICAgICAgICAgIHNldmVyaXR5OiB3YXJuaW5nCiAgICAgICAgYW5ub3RhdGlvbnM6CiAgICAgICAgICBzdW1tYXJ5OiAiSGlnaCBDUFUgdXNhZ2UgZGV0ZWN0ZWQiCiAgICAgICAgICBkZXNjcmlwdGlvbjogIkNQVSB1c2FnZSBpcyBhYm92ZSA4MCUgZm9yIG1vcmUgdGhhbiA1IG1pbnV0ZXMuIg=="))));alert("¡Copiado!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>groups:
  - name: example
    rules:
      - alert: HighCPUUsage
        expr: sum(rate(container_cpu_usage_seconds_total[5m])) by (instance) &gt; 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &quot;High CPU usage detected&quot;
          description: &quot;CPU usage is above 80% for more than 5 minutes.&quot;</pre></div><div class='content'></div><h2>Configuración de Alertmanager</h2>
<div class='content'><p>Alertmanager maneja las alertas enviadas por Prometheus y puede enrutar las alertas a varios receptores como correo electrónico, Slack o PagerDuty.</p>
<ol>
<li>
<p><strong>Desplegar Alertmanager</strong>:</p>
<pre><code class="language-bash">helm install alertmanager prometheus-community/alertmanager
</code></pre>
</li>
<li>
<p><strong>Configurar Alertmanager</strong>:
Crea un archivo de configuración (<code>alertmanager.yml</code>):</p>
<pre><code class="language-yaml">global:
  resolve_timeout: 5m

route:
  receiver: 'slack-notifications'

receivers:
  - name: 'slack-notifications'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX'
        channel: '#alerts'
</code></pre>
</li>
</ol>
</div><h1>Conclusión</h1>
<div class='content'><p>Monitorear un clúster de Kubernetes con Prometheus implica configurar Prometheus, configurarlo para recopilar métricas de varias fuentes, visualizar estas métricas con Grafana y configurar alertas para notificarte de cualquier problema. Siguiendo los pasos descritos en este tema, puedes asegurarte de que tu clúster de Kubernetes esté bien monitoreado y de que se te notifique rápidamente sobre cualquier problema potencial.</p>
</div><div class='row navigation'>
	<div class='col-4'>
					<a href='kubernetes-api-and-kubectl'>&#x25C4;API de Kubernetes y kubectl</a>
			</div>
	<div class='col-4 text-center'>
		<a href="./" class="title">Monitoreo con Prometheus</a>
	</div>
	<div class='col-4 text-end'>
					<a href='logging-with-efk'>Registro con Elasticsearch, Fluentd y Kibana (EFK) &#x25BA;</a>
			</div>
</div>
</div>
		</div>
		<div class="col-12 col-lg-4 publi" id="div_publi">
			<h1>Publicidad</h1>
			<p>Este espacio está destinado a publicidad.</p>
			<p>Si quieres ser patrocinador, contáctanos para incluir enlaces en esta zona: <a href='mailto:admin@campusempresa.cat'>admin@campusempresa.cat</a></p>
			<p>¡Gracias por colaborar!</p>
		</div>
	</div>
</div>

   <div class="container-xxl my-3">
	<div class="row">
		<div class="col">
			<footer>&copy; Copyright 2024. Todos los derechos reservados</footer>
		</div>
	</div>
</div>	

<div id="cookies_adv" style="display:none;">
	Fem servir galetes per millorar la teva experiència d'ús i oferir continguts adaptats als teus interessos
    <a href="#" id="btn_accept_cookies" class="button">Aceptar</a>
    <a href="/cookies">Mas información</a>
</div>	

	</div>    
</body>
</html>
